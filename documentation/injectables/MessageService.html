<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>dabubble documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	   <link rel="stylesheet" href="../styles/style.css">
        <link rel="stylesheet" href="../styles/dark.css">
    </head>
    <body>
          <script>
               // Blocking script to avoid flickering dark mode
               // Dark mode toggle button
               var useDark = window.matchMedia('(prefers-color-scheme: dark)');
               var darkModeState = useDark.matches;
               var $darkModeToggleSwitchers = document.querySelectorAll('.dark-mode-switch input');
               var $darkModeToggles = document.querySelectorAll('.dark-mode-switch');
               var darkModeStateLocal = localStorage.getItem('compodoc_darkmode-state');

               function checkToggle(check) {
                    for (var i = 0; i < $darkModeToggleSwitchers.length; i++) {
                         $darkModeToggleSwitchers[i].checked = check;
                    }
               }

               function toggleDarkMode(state) {
                    if (window.localStorage) {
                         localStorage.setItem('compodoc_darkmode-state', state);
                    }

                    checkToggle(state);

                    const hasClass = document.body.classList.contains('dark');

                    if (state) {
                         for (var i = 0; i < $darkModeToggles.length; i++) {
                              $darkModeToggles[i].classList.add('dark');
                         }
                         if (!hasClass) {
                              document.body.classList.add('dark');
                         }
                    } else {
                         for (var i = 0; i < $darkModeToggles.length; i++) {
                              $darkModeToggles[i].classList.remove('dark');
                         }
                         if (hasClass) {
                              document.body.classList.remove('dark');
                         }
                    }
               }

               useDark.addEventListener('change', function (evt) {
                    toggleDarkMode(evt.matches);
               });
               if (darkModeStateLocal) {
                    darkModeState = darkModeStateLocal === 'true';
               }
               toggleDarkMode(darkModeState);
          </script>

        <div class="navbar navbar-default navbar-fixed-top d-md-none p-0">
               <div class="d-flex">
                    <a href="../" class="navbar-brand">dabubble documentation</a>
                    <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
               </div>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="d-none d-md-block menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content injectable">
                   <div class="content-data">








<ol class="breadcrumb">
  <li class="breadcrumb-item">Injectables</li>
  <li class="breadcrumb-item" >MessageService</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="nav-item">
            <a href="#info" 
                class="nav-link"
                class="nav-link active"
                role="tab" id="info-tab" data-bs-toggle="tab" data-link="info">Info</a>
        </li>
        <li class="nav-item">
            <a href="#source" 
                class="nav-link"
                
                role="tab" id="source-tab" data-bs-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>src/app/message.service.ts</code>
        </p>


            <p class="comment">
                <h3>Description</h3>
            </p>
            <p class="comment">
                <p>MessageService handles sending, querying, and updating messages of
different types in Firestore. It also supports reply counting and
real-time updates of emojis and thread data.</p>

            </p>



            <section data-compodoc="block-index">
    <h3 id="index">Index</h3>
    <table class="table table-sm table-bordered index-table">
        <tbody>

                <tr>
                    <td class="col-md-4">
                        <h6><b>Methods</b></h6>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <ul class="index-list">
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#addEmojiToThreadMessage" >addEmojiToThreadMessage</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                <a href="#buildListenForMessagesQuery" >buildListenForMessagesQuery</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                <a href="#buildListenMessagesQuery" >buildListenMessagesQuery</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                <a href="#buildMessagePayload" >buildMessagePayload</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                <a href="#buildPrivateMessagesQuery" >buildPrivateMessagesQuery</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                <a href="#buildQueryByType" >buildQueryByType</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                <a href="#buildQueryForId" >buildQueryForId</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                <a href="#buildThreadMessagesQuery" >buildThreadMessagesQuery</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                    <span class="modifier">Async</span>
                                <a href="#commitMessage" >commitMessage</a>
                            </li>
                            <li>
                                    <span class="modifier">Public</span>
                                <a href="#convertToDate" >convertToDate</a>
                            </li>
                            <li>
                                <a href="#convertToTime" >convertToTime</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                    <span class="modifier">Async</span>
                                <a href="#countFilteredReplies" >countFilteredReplies</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                <a href="#extractThreadEmojis" >extractThreadEmojis</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                    <span class="modifier">Async</span>
                                <a href="#fetchReplyCountAndTime" >fetchReplyCountAndTime</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                    <span class="modifier">Async</span>
                                <a href="#fetchThreadEmojis" >fetchThreadEmojis</a>
                            </li>
                            <li>
                                    <span class="modifier">Public</span>
                                    <span class="modifier">Async</span>
                                <a href="#findChannelIdIfMissing" >findChannelIdIfMissing</a>
                            </li>
                            <li>
                                <a href="#generateConversationId" >generateConversationId</a>
                            </li>
                            <li>
                                    <span class="modifier">Public</span>
                                <a href="#getBroadcastMessages" >getBroadcastMessages</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getChannelMessagesOnce" >getChannelMessagesOnce</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                    <span class="modifier">Async</span>
                                <a href="#getExistingThreadEmojis" >getExistingThreadEmojis</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                <a href="#getFilterField" >getFilterField</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                <a href="#getFilterFieldForReplies" >getFilterFieldForReplies</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getLastUsedEmojis" >getLastUsedEmojis</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getLastUsedThreadEmojis" >getLastUsedThreadEmojis</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getMessage" >getMessage</a>
                            </li>
                            <li>
                                <a href="#getMessages" >getMessages</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getMessagesOnce" >getMessagesOnce</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                    <span class="modifier">Async</span>
                                <a href="#getParentDocData" >getParentDocData</a>
                            </li>
                            <li>
                                <a href="#getPrivateMessagesLive" >getPrivateMessagesLive</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getReplyCountsForMessages" >getReplyCountsForMessages</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                <a href="#getReplyFilterField" >getReplyFilterField</a>
                            </li>
                            <li>
                                <a href="#getThreadMessagesLive" >getThreadMessagesLive</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                <a href="#handleRecipientSnapshot" >handleRecipientSnapshot</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                <a href="#incrementOrAddEmoji" >incrementOrAddEmoji</a>
                            </li>
                            <li>
                                <a href="#listenForEmojiUpdates" >listenForEmojiUpdates</a>
                            </li>
                            <li>
                                <a href="#listenForMessages" >listenForMessages</a>
                            </li>
                            <li>
                                <a href="#listenForThreadDetails" >listenForThreadDetails</a>
                            </li>
                            <li>
                                <a href="#listenForThreadEmojiUpdates" >listenForThreadEmojiUpdates</a>
                            </li>
                            <li>
                                <a href="#listenMessages" >listenMessages</a>
                            </li>
                            <li>
                                <a href="#loadReplyCountsLive" >loadReplyCountsLive</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                <a href="#mapMessagesDocs" >mapMessagesDocs</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                <a href="#mapMessagesOnce" >mapMessagesOnce</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                <a href="#mapPrivateMessages" >mapPrivateMessages</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                <a href="#mapReplySnapshot" >mapReplySnapshot</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                <a href="#mapSnapshotDocs" >mapSnapshotDocs</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                <a href="#mapThreadSnapshot" >mapThreadSnapshot</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                <a href="#mergeNewAndExistingEmojis" >mergeNewAndExistingEmojis</a>
                            </li>
                            <li>
                                    <span class="modifier">Public</span>
                                <a href="#onAllUsersChanged" >onAllUsersChanged</a>
                            </li>
                            <li>
                                    <span class="modifier">Public</span>
                                <a href="#onRecipientStatusChanged" >onRecipientStatusChanged</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                <a href="#resolveFieldName" >resolveFieldName</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#saveLastUsedEmojis" >saveLastUsedEmojis</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#saveLastUsedThreadEmojis" >saveLastUsedThreadEmojis</a>
                            </li>
                            <li>
                                    <span class="modifier">Public</span>
                                    <span class="modifier">Async</span>
                                <a href="#sendBroadcastMessage" >sendBroadcastMessage</a>
                            </li>
                            <li>
                                    <span class="modifier">Public</span>
                                    <span class="modifier">Async</span>
                                <a href="#sendChannelMessage" >sendChannelMessage</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#sendMessage" >sendMessage</a>
                            </li>
                            <li>
                                    <span class="modifier">Public</span>
                                    <span class="modifier">Async</span>
                                <a href="#setUserOnlineStatus" >setUserOnlineStatus</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                    <span class="modifier">Async</span>
                                <a href="#storeThreadEmojis" >storeThreadEmojis</a>
                            </li>
                            <li>
                                    <span class="modifier">Public</span>
                                    <span class="modifier">Async</span>
                                <a href="#updateMessage" >updateMessage</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#updateReplyCount" >updateReplyCount</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                    <span class="modifier">Async</span>
                                <a href="#updateReplyCountInParent" >updateReplyCountInParent</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                    <span class="modifier">Async</span>
                                <a href="#updateThreadEmojisInDoc" >updateThreadEmojisInDoc</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#updateThreadLastResponseTime" >updateThreadLastResponseTime</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                <a href="#validateThreadChannel" >validateThreadChannel</a>
                            </li>
                        </ul>
                    </td>
                </tr>





        </tbody>
    </table>
</section>

            <section data-compodoc="block-constructor">
    <h3 id="constructor">Constructor</h3>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
<code>constructor(firestore: Firestore, channelService: <a href="../injectables/ChannelService.html" target="_self">ChannelService</a>)</code>
                    </td>
                </tr>
                        <tr>
                            <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="58" class="link-to-prism">src/app/message.service.ts:58</a></div>
                            </td>
                        </tr>

                <tr>
                    <td class="col-md-4">
                            <div>
                                    <b>Parameters :</b>
                                    <table class="params">
                                        <thead>
                                            <tr>
                                                <td>Name</td>
                                                    <td>Type</td>
                                                <td>Optional</td>
                                            </tr>
                                        </thead>
                                        <tbody>
                                                <tr>
                                                        <td>firestore</td>
                                                  
                                                        <td>
                                                                    <code>Firestore</code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>channelService</td>
                                                  
                                                        <td>
                                                                        <code><a href="../injectables/ChannelService.html" target="_self" >ChannelService</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                        </tbody>
                                    </table>
                            </div>
                    </td>
                </tr>
            </tbody>
        </table>
</section>

            <section data-compodoc="block-methods">
    
    <h3 id="methods">
        Methods
    </h3>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="addEmojiToThreadMessage"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>addEmojiToThreadMessage</b></span>
                        <a href="#addEmojiToThreadMessage"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>addEmojiToThreadMessage(threadId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, emoji: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, senderId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="748"
                                    class="link-to-prism">src/app/message.service.ts:748</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>addEmojiToThreadMessage increments or adds an emoji (by &#39;emoji&#39; string) within a thread&#39;s
content.emojis array. Then, it updates lastUsedEmojis in Firestore as &#39;sent&#39; or &#39;received&#39;.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                                <td>Description</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>threadId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>The doc ID representing this thread message in Firestore.</li>
</ul>

                                            </td>
                                        </tr>
                                        <tr>
                                                <td>emoji</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>The new emoji to add or increment.</li>
</ul>

                                            </td>
                                        </tr>
                                        <tr>
                                                <td>senderId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>The ID of the user sending the emoji, used to decide &#39;sent&#39; or &#39;received&#39;.</li>
</ul>

                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;void&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="buildListenForMessagesQuery"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                        <span ><b>buildListenForMessagesQuery</b></span>
                        <a href="#buildListenForMessagesQuery"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>buildListenForMessagesQuery(type: "private" | "thread" | "thread-channel", parentId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="302"
                                    class="link-to-prism">src/app/message.service.ts:302</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Constructs the Firestore query based on type and parentId, ordering by timestamp.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>type</td>
                                            <td>
                                                        <code>&quot;private&quot; | &quot;thread&quot; | &quot;thread-channel&quot;</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>parentId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="buildListenMessagesQuery"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                        <span ><b>buildListenMessagesQuery</b></span>
                        <a href="#buildListenMessagesQuery"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>buildListenMessagesQuery(type: "private" | "thread" | "thread-channel", id: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="245"
                                    class="link-to-prism">src/app/message.service.ts:245</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Builds the Firestore query based on message type and ID.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>type</td>
                                            <td>
                                                        <code>&quot;private&quot; | &quot;thread&quot; | &quot;thread-channel&quot;</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>id</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="buildMessagePayload"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                        <span ><b>buildMessagePayload</b></span>
                        <a href="#buildMessagePayload"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>buildMessagePayload(data: <a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank">any</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="111"
                                    class="link-to-prism">src/app/message.service.ts:111</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Creates the final message object that will be stored in Firestore.
By separating this out, your main method stays concise.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>data</td>
                                            <td>
                                                            <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="buildPrivateMessagesQuery"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                        <span ><b>buildPrivateMessagesQuery</b></span>
                        <a href="#buildPrivateMessagesQuery"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>buildPrivateMessagesQuery(conversationId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="587"
                                    class="link-to-prism">src/app/message.service.ts:587</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Builds the Firestore query for private messages in a specific conversation.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>conversationId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="buildQueryByType"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                        <span ><b>buildQueryByType</b></span>
                        <a href="#buildQueryByType"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>buildQueryByType(type: "private" | "thread" | "thread-channel")</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="199"
                                    class="link-to-prism">src/app/message.service.ts:199</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Builds a Firestore query if no ID is given, just filtering by type.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>type</td>
                                            <td>
                                                        <code>&quot;private&quot; | &quot;thread&quot; | &quot;thread-channel&quot;</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="buildQueryForId"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                        <span ><b>buildQueryForId</b></span>
                        <a href="#buildQueryForId"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>buildQueryForId(type: "private" | "thread" | "thread-channel", id: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="181"
                                    class="link-to-prism">src/app/message.service.ts:181</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Builds a Firestore query for a given type + ID (conversation or thread).</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>type</td>
                                            <td>
                                                        <code>&quot;private&quot; | &quot;thread&quot; | &quot;thread-channel&quot;</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>id</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="buildThreadMessagesQuery"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                        <span ><b>buildThreadMessagesQuery</b></span>
                        <a href="#buildThreadMessagesQuery"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>buildThreadMessagesQuery(threadId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="817"
                                    class="link-to-prism">src/app/message.service.ts:817</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Builds the Firestore query to retrieve &#39;thread&#39;-type messages sorted by timestamp.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>threadId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="commitMessage"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                            <span class="modifier">Async</span>
                        <span ><b>commitMessage</b></span>
                        <a href="#commitMessage"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>commitMessage(payload: <a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank">any</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="124"
                                    class="link-to-prism">src/app/message.service.ts:124</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Adds the message document to Firestore and returns its doc ID.
Extracting this step clarifies exactly where the database write happens.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>payload</td>
                                            <td>
                                                            <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;string&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="convertToDate"></a>
                    <span class="name">
                            <span class="modifier">Public</span>
                        <span ><b>convertToDate</b></span>
                        <a href="#convertToDate"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>convertToDate(timestamp: <a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank">any</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="633"
                                    class="link-to-prism">src/app/message.service.ts:633</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>convertToDate attempts to convert an unknown timestamp input to a JavaScript Date,
returning null if unable. Suitable for Firestore docs that store Timestamps or numbers.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                                <td>Description</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>timestamp</td>
                                            <td>
                                                            <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>Possibly a Firestore timestamp, a Date, or numeric.</li>
</ul>

                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Date | null</code>

                        </div>
                            <div class="io-description">
                                <p>A Date object or null on failure.</p>

                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="convertToTime"></a>
                    <span class="name">
                        <span ><b>convertToTime</b></span>
                        <a href="#convertToTime"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>convertToTime(timestamp: <a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank">any</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="615"
                                    class="link-to-prism">src/app/message.service.ts:615</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>convertToTime takes a Firestore timestamp or numeric value and returns a
localized time string (HH:MM) in &#39;de-DE&#39; format.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                                <td>Description</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>timestamp</td>
                                            <td>
                                                            <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>The Firestore timestamp or numeric timestamp in milliseconds.</li>
</ul>

                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                        </div>
                            <div class="io-description">
                                <p>A string with hour:minute.</p>

                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="countFilteredReplies"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                            <span class="modifier">Async</span>
                        <span ><b>countFilteredReplies</b></span>
                        <a href="#countFilteredReplies"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>countFilteredReplies(field: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, parentId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="367"
                                    class="link-to-prism">src/app/message.service.ts:367</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Counts how many reply documents exist that match the given field and parent ID.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>field</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>parentId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;number&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="extractThreadEmojis"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                        <span ><b>extractThreadEmojis</b></span>
                        <a href="#extractThreadEmojis"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>extractThreadEmojis(data: <a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank">any</a>, type: "sent" | "received")</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="920"
                                    class="link-to-prism">src/app/message.service.ts:920</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Extracts the relevant emoji array (sent or received) from the document data, limited to 2 items.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>data</td>
                                            <td>
                                                            <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>type</td>
                                            <td>
                                                        <code>&quot;sent&quot; | &quot;received&quot;</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>string[]</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="fetchReplyCountAndTime"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                            <span class="modifier">Async</span>
                        <span ><b>fetchReplyCountAndTime</b></span>
                        <a href="#fetchReplyCountAndTime"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>fetchReplyCountAndTime(field: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, messageId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="421"
                                    class="link-to-prism">src/app/message.service.ts:421</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Fetches the reply count and the latest response time for a given messageId.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>field</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>messageId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;literal type&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="fetchThreadEmojis"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                            <span class="modifier">Async</span>
                        <span ><b>fetchThreadEmojis</b></span>
                        <a href="#fetchThreadEmojis"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>fetchThreadEmojis(threadId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="764"
                                    class="link-to-prism">src/app/message.service.ts:764</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Fetches the current list of emojis from the thread&#39;s Firestore document,
returning an array of { emoji, count } objects.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>threadId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;literal type[]&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="findChannelIdIfMissing"></a>
                    <span class="name">
                            <span class="modifier">Public</span>
                            <span class="modifier">Async</span>
                        <span ><b>findChannelIdIfMissing</b></span>
                        <a href="#findChannelIdIfMissing"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>findChannelIdIfMissing(msg: <a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank">any</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="1136"
                                    class="link-to-prism">src/app/message.service.ts:1136</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Finds the main channelId for a thread-channel message by checking its
own channelId field or looking up the parent message if channelId is null.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                                <td>Description</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>msg</td>
                                            <td>
                                                            <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>The message object (requires threadChannelId or parentId).</li>
</ul>

                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;string | null&gt;</code>

                        </div>
                            <div class="io-description">
                                <p>A promise resolving to the channel ID or null if not found.</p>

                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="generateConversationId"></a>
                    <span class="name">
                        <span ><b>generateConversationId</b></span>
                        <a href="#generateConversationId"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>generateConversationId(userId1: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, userId2: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="72"
                                    class="link-to-prism">src/app/message.service.ts:72</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>generateConversationId sorts two user IDs alphabetically, then joins them with an underscore
to produce a stable, unique conversation ID for private messages.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                                <td>Description</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>userId1</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>The first user ID.</li>
</ul>

                                            </td>
                                        </tr>
                                        <tr>
                                                <td>userId2</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>The second user ID.</li>
</ul>

                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                        </div>
                            <div class="io-description">
                                <p>A string conversation ID for Firestore queries.</p>

                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getBroadcastMessages"></a>
                    <span class="name">
                            <span class="modifier">Public</span>
                        <span ><b>getBroadcastMessages</b></span>
                        <a href="#getBroadcastMessages"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getBroadcastMessages(channelId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="1117"
                                    class="link-to-prism">src/app/message.service.ts:1117</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Retrieves all broadcast messages for the specified channel ID.
Messages are returned in ascending order by timestamp.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                                <td>Description</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>channelId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>The channel ID used to filter broadcast messages</li>
</ul>

                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Observable&lt;any[]&gt;</code>

                        </div>
                            <div class="io-description">
                                <p>An Observable emitting an array of broadcast messages</p>

                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getChannelMessagesOnce"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>getChannelMessagesOnce</b></span>
                        <a href="#getChannelMessagesOnce"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getChannelMessagesOnce()</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="960"
                                    class="link-to-prism">src/app/message.service.ts:960</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Fetches all channel messages once, then filters out those
from channels where the current user isn&#39;t a member.</p>
</div>

                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;ChannelMessageData[]&gt;</code>

                        </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getExistingThreadEmojis"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                            <span class="modifier">Async</span>
                        <span ><b>getExistingThreadEmojis</b></span>
                        <a href="#getExistingThreadEmojis"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getExistingThreadEmojis(threadId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, field: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="866"
                                    class="link-to-prism">src/app/message.service.ts:866</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Fetches the existing emojis array from the Firestore doc. If doc doesn&#39;t exist, returns [].</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>threadId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>field</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;string[]&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getFilterField"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                        <span ><b>getFilterField</b></span>
                        <a href="#getFilterField"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getFilterField(type: "private" | "thread" | "thread-channel")</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="360"
                                    class="link-to-prism">src/app/message.service.ts:360</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Determines which field to filter by, based on message type.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>type</td>
                                            <td>
                                                        <code>&quot;private&quot; | &quot;thread&quot; | &quot;thread-channel&quot;</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getFilterFieldForReplies"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                        <span ><b>getFilterFieldForReplies</b></span>
                        <a href="#getFilterFieldForReplies"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getFilterFieldForReplies(type: "private" | "thread" | "thread-channel")</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="414"
                                    class="link-to-prism">src/app/message.service.ts:414</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Returns the correct Firestore field for message replies based on the given type.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>type</td>
                                            <td>
                                                        <code>&quot;private&quot; | &quot;thread&quot; | &quot;thread-channel&quot;</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getLastUsedEmojis"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>getLastUsedEmojis</b></span>
                        <a href="#getLastUsedEmojis"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getLastUsedEmojis(conversationId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, type: "sent" | "received")</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="694"
                                    class="link-to-prism">src/app/message.service.ts:694</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>getLastUsedEmojis loads the last-used emojis array (either &#39;sent&#39; or &#39;received&#39;) from
a conversation doc in Firestore.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                                <td>Description</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>conversationId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>The Firestore doc ID for the conversation.</li>
</ul>

                                            </td>
                                        </tr>
                                        <tr>
                                                <td>type</td>
                                            <td>
                                                        <code>&quot;sent&quot; | &quot;received&quot;</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>&#39;sent&#39; or &#39;received&#39;, specifying which field to read.</li>
</ul>

                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;string[]&gt;</code>

                        </div>
                            <div class="io-description">
                                <p>An array of up to 2 emojis if they exist.</p>

                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getLastUsedThreadEmojis"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>getLastUsedThreadEmojis</b></span>
                        <a href="#getLastUsedThreadEmojis"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getLastUsedThreadEmojis(threadId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, type: "sent" | "received")</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="904"
                                    class="link-to-prism">src/app/message.service.ts:904</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>getLastUsedThreadEmojis fetches either the sent or received last-used emojis array
from a Firestore &#39;messages&#39; doc that holds a thread&#39;s parent message. The doc must
store lastUsedEmojisSent or lastUsedEmojisReceived fields.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                                <td>Description</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>threadId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>The ID referencing the parent thread message doc.</li>
</ul>

                                            </td>
                                        </tr>
                                        <tr>
                                                <td>type</td>
                                            <td>
                                                        <code>&quot;sent&quot; | &quot;received&quot;</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>&#39;sent&#39; or &#39;received&#39; deciding which field to read.</li>
</ul>

                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;string[]&gt;</code>

                        </div>
                            <div class="io-description">
                                <p>Up to two emoji strings.</p>

                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getMessage"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>getMessage</b></span>
                        <a href="#getMessage"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getMessage(type: "private" | "channel" | "thread" | "thread-channel", messageId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="545"
                                    class="link-to-prism">src/app/message.service.ts:545</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>getMessage retrieves a single message document by ID from Firestore,
converting its Firestore timestamp to a JavaScript Date.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                                <td>Description</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>type</td>
                                            <td>
                                                        <code>&quot;private&quot; | &quot;channel&quot; | &quot;thread&quot; | &quot;thread-channel&quot;</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>The message type (unused in logic, can be for debugging/logging).</li>
</ul>

                                            </td>
                                        </tr>
                                        <tr>
                                                <td>messageId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>The Firestore doc ID of the message.</li>
</ul>

                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="../interfaces/Message.html" target="_self" >Promise&lt;Message | null&gt;</a></code>

                        </div>
                            <div class="io-description">
                                <p>A message object with an additional <code>timestamp</code> as a JS Date, or null if not found.</p>

                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getMessages"></a>
                    <span class="name">
                        <span ><b>getMessages</b></span>
                        <a href="#getMessages"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>getMessages(channelId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, threadChannelId?: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="138"
                                    class="link-to-prism">src/app/message.service.ts:138</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>getMessages can be used to fetch messages for a channel or a specific threadChannelId.
It returns a live Observable of message arrays.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                                <td>Description</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>channelId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>The ID of the channel.</li>
</ul>

                                            </td>
                                        </tr>
                                        <tr>
                                                <td>threadChannelId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    Yes
                                            </td>


                                            <td>
                                                    <ul>
<li>If provided, only messages for that thread-channel are fetched.</li>
</ul>

                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Observable&lt;any[]&gt;</code>

                        </div>
                            <div class="io-description">
                                <p>An Observable of message arrays.</p>

                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getMessagesOnce"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>getMessagesOnce</b></span>
                        <a href="#getMessagesOnce"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getMessagesOnce(type: "private" | "thread" | "thread-channel", id?: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="169"
                                    class="link-to-prism">src/app/message.service.ts:169</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>getMessagesOnce performs a one-time Firestore query for messages of a specific type
(private, thread, or thread-channel) and optionally filters by a conversation or thread ID.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                                <td>Description</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>type</td>
                                            <td>
                                                        <code>&quot;private&quot; | &quot;thread&quot; | &quot;thread-channel&quot;</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>The message category: &#39;private&#39; | &#39;thread&#39; | &#39;thread-channel&#39;.</li>
</ul>

                                            </td>
                                        </tr>
                                        <tr>
                                                <td>id</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    Yes
                                            </td>


                                            <td>
                                                    <ul>
<li>The optional ID to filter by (e.g., conversationId or threadChannelId).</li>
</ul>

                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;any[]&gt;</code>

                        </div>
                            <div class="io-description">
                                <p>A promise that resolves to an array of messages.</p>

                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getParentDocData"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                            <span class="modifier">Async</span>
                        <span ><b>getParentDocData</b></span>
                        <a href="#getParentDocData"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getParentDocData(ref: <a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank">any</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="354"
                                    class="link-to-prism">src/app/message.service.ts:354</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Fetches parent doc data from Firestore, or null if it doesn&#39;t exist.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>ref</td>
                                            <td>
                                                            <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;any | null&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getPrivateMessagesLive"></a>
                    <span class="name">
                        <span ><b>getPrivateMessagesLive</b></span>
                        <a href="#getPrivateMessagesLive"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>getPrivateMessagesLive(conversationId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, callback: (messages: any[]) => void)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="575"
                                    class="link-to-prism">src/app/message.service.ts:575</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>getPrivateMessagesLive attaches a snapshot listener to private messages
within a conversationId, sorted ascending by timestamp.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                                <td>Description</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>conversationId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>The ID of the private conversation to track.</li>
</ul>

                                            </td>
                                        </tr>
                                        <tr>
                                                <td>callback</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/function" target="_blank" >function</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>Invoked whenever snapshot changes with updated messages array.</li>
</ul>

                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >void</a></code>

                        </div>
                            <div class="io-description">
                                <p>An unsubscribe function.</p>

                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getReplyCountsForMessages"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>getReplyCountsForMessages</b></span>
                        <a href="#getReplyCountsForMessages"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getReplyCountsForMessages(messageIds: string[], type: "private" | "thread" | "thread-channel")</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="397"
                                    class="link-to-prism">src/app/message.service.ts:397</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>getReplyCountsForMessages loops over an array of message IDs and calculates how many
replies each has, returning an object keyed by messageId. Optionally updates the last
response time if a reply is found.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                                <td>Description</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>messageIds</td>
                                            <td>
                                                        <code>string[]</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>An array of Firestore doc IDs for parent messages.</li>
</ul>

                                            </td>
                                        </tr>
                                        <tr>
                                                <td>type</td>
                                            <td>
                                                        <code>&quot;private&quot; | &quot;thread&quot; | &quot;thread-channel&quot;</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>The type used to identify the correct filter field in Firestore.</li>
</ul>

                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="../miscellaneous/typealiases.html#ReplyCountsMap" target="_self" >Promise&lt;ReplyCountsMap&gt;</a></code>

                        </div>
                            <div class="io-description">
                                <p>A map of message IDs to reply counts and lastResponseTime.</p>

                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getReplyFilterField"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                        <span ><b>getReplyFilterField</b></span>
                        <a href="#getReplyFilterField"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getReplyFilterField(type: "private" | "thread" | "thread-channel")</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="477"
                                    class="link-to-prism">src/app/message.service.ts:477</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Returns the correct Firestore field (threadChannelId or parentId) for the given message type.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>type</td>
                                            <td>
                                                        <code>&quot;private&quot; | &quot;thread&quot; | &quot;thread-channel&quot;</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getThreadMessagesLive"></a>
                    <span class="name">
                        <span ><b>getThreadMessagesLive</b></span>
                        <a href="#getThreadMessagesLive"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>getThreadMessagesLive(threadId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, callback: (messages: any[]) => void)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="802"
                                    class="link-to-prism">src/app/message.service.ts:802</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>getThreadMessagesLive attaches a snapshot listener for real-time updates
to a &#39;thread&#39; type message set, filtered by threadId, sorted by ascending timestamp.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                                <td>Description</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>threadId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>The ID that identifies this thread in Firestore.</li>
</ul>

                                            </td>
                                        </tr>
                                        <tr>
                                                <td>callback</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/function" target="_blank" >function</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>Invoked with an array of messages every time there&#39;s a snapshot update.</li>
</ul>

                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >void</a></code>

                        </div>
                            <div class="io-description">
                                <p>An unsubscribe function.</p>

                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="handleRecipientSnapshot"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                        <span ><b>handleRecipientSnapshot</b></span>
                        <a href="#handleRecipientSnapshot"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>handleRecipientSnapshot(docSnap: <a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank">any</a>, callback: (data: literal type) => void)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="1018"
                                    class="link-to-prism">src/app/message.service.ts:1018</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Processes the snapshot data and invokes the callback with the appropriate status info.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>docSnap</td>
                                            <td>
                                                            <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>callback</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/function" target="_blank" >function</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >void</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="incrementOrAddEmoji"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                        <span ><b>incrementOrAddEmoji</b></span>
                        <a href="#incrementOrAddEmoji"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>incrementOrAddEmoji(emojis: literal type[], newEmoji: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="775"
                                    class="link-to-prism">src/app/message.service.ts:775</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Increments the count of an existing emoji or adds it if not found.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>emojis</td>
                                            <td>
                                                        <code>literal type[]</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>newEmoji</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >void</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="listenForEmojiUpdates"></a>
                    <span class="name">
                        <span ><b>listenForEmojiUpdates</b></span>
                        <a href="#listenForEmojiUpdates"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>listenForEmojiUpdates(conversationId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, callback: (sent: string[],received: string[]) => void)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="667"
                                    class="link-to-prism">src/app/message.service.ts:667</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>listenForEmojiUpdates attaches a listener to a single messages document in Firestore,
typically used for saving last-used emojis for conversation references.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                                <td>Description</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>conversationId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>The Firestore doc ID for the conversation&#39;s &quot;messages&quot; doc.</li>
</ul>

                                            </td>
                                        </tr>
                                        <tr>
                                                <td>callback</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/function" target="_blank" >function</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>Invoked with two arrays: the last used &#39;sent&#39; and &#39;received&#39; emojis.</li>
</ul>

                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >void</a></code>

                        </div>
                            <div class="io-description">
                                <p>A function to unsubscribe from snapshot updates.</p>

                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="listenForMessages"></a>
                    <span class="name">
                        <span ><b>listenForMessages</b></span>
                        <a href="#listenForMessages"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>listenForMessages(type: "private" | "thread" | "thread-channel", parentId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, callback: (messages: any[]) => void)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="292"
                                    class="link-to-prism">src/app/message.service.ts:292</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>listenForMessages sets up a Firestore query for messages with a specified type
(private, thread, or thread-channel) and a parentId or threadChannelId.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                                <td>Description</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>type</td>
                                            <td>
                                                        <code>&quot;private&quot; | &quot;thread&quot; | &quot;thread-channel&quot;</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>One of the recognized message types.</li>
</ul>

                                            </td>
                                        </tr>
                                        <tr>
                                                <td>parentId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>The relevant parent ID (conversation, thread, or channel).</li>
</ul>

                                            </td>
                                        </tr>
                                        <tr>
                                                <td>callback</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/function" target="_blank" >function</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>Fired on every change, receiving the updated messages array.</li>
</ul>

                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >void</a></code>

                        </div>
                            <div class="io-description">
                                <p>A function to unsubscribe from live updates.</p>

                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="listenForThreadDetails"></a>
                    <span class="name">
                        <span ><b>listenForThreadDetails</b></span>
                        <a href="#listenForThreadDetails"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>listenForThreadDetails(threadId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, callback: (data: <a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank">any</a>) => void)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="506"
                                    class="link-to-prism">src/app/message.service.ts:506</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>listenForThreadDetails sets a snapshot listener on a single message doc in Firestore
(representing a thread), invoking the callback whenever the doc changes or is updated.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                                <td>Description</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>threadId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>The Firestore doc ID to watch.</li>
</ul>

                                            </td>
                                        </tr>
                                        <tr>
                                                <td>callback</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/function" target="_blank" >function</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>Called with the latest document data on changes.</li>
</ul>

                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >void</a></code>

                        </div>
                            <div class="io-description">
                                <p>A function to unsubscribe from the snapshot.</p>

                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="listenForThreadEmojiUpdates"></a>
                    <span class="name">
                        <span ><b>listenForThreadEmojiUpdates</b></span>
                        <a href="#listenForThreadEmojiUpdates"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>listenForThreadEmojiUpdates(threadId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, callback: (sentEmojis: string[],receivedEmojis: string[]) => void)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="936"
                                    class="link-to-prism">src/app/message.service.ts:936</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>listenForThreadEmojiUpdates attaches a real-time snapshot listener for a single
&#39;messages&#39; doc that represents the parent message of a thread, updating the
lastUsedEmojisSent and lastUsedEmojisReceived fields as changes occur.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                                <td>Description</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>threadId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>The Firestore doc ID for the parent thread message.</li>
</ul>

                                            </td>
                                        </tr>
                                        <tr>
                                                <td>callback</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/function" target="_blank" >function</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>Fired with two arrays: updatedEmojisSent and updatedEmojisReceived.</li>
</ul>

                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >void</a></code>

                        </div>
                            <div class="io-description">
                                <p>A function to unsubscribe from the snapshot.</p>

                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="listenMessages"></a>
                    <span class="name">
                        <span ><b>listenMessages</b></span>
                        <a href="#listenMessages"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>listenMessages(type: "private" | "thread" | "thread-channel", id: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, callback: (messages: any[]) => void)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="229"
                                    class="link-to-prism">src/app/message.service.ts:229</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>listenMessages sets up a snapshot listener for live updates on messages
matching the specified type (private, thread, or thread-channel) and ID.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                                <td>Description</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>type</td>
                                            <td>
                                                        <code>&quot;private&quot; | &quot;thread&quot; | &quot;thread-channel&quot;</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>The message type category.</li>
</ul>

                                            </td>
                                        </tr>
                                        <tr>
                                                <td>id</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>The conversation or thread ID to filter by.</li>
</ul>

                                            </td>
                                        </tr>
                                        <tr>
                                                <td>callback</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/function" target="_blank" >function</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>A function invoked whenever new snapshot data arrives.</li>
</ul>

                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >void</a></code>

                        </div>
                            <div class="io-description">
                                <p>A function to unsubscribe from the snapshot listener.</p>

                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="loadReplyCountsLive"></a>
                    <span class="name">
                        <span ><b>loadReplyCountsLive</b></span>
                        <a href="#loadReplyCountsLive"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>loadReplyCountsLive(messageIds: string[], type: "private" | "thread" | "thread-channel", callback: (replyCounts: <a href="../undefineds/ReplyCountsMap.html">ReplyCountsMap</a>) => void)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="451"
                                    class="link-to-prism">src/app/message.service.ts:451</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>loadReplyCountsLive sets up individual snapshot listeners for each parent messageId,
aggregating reply counts and last response times in a central object that&#39;s passed to
the provided callback. Returns a function to unsubscribe all.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                                <td>Description</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>messageIds</td>
                                            <td>
                                                        <code>string[]</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>The IDs of parent messages to track.</li>
</ul>

                                            </td>
                                        </tr>
                                        <tr>
                                                <td>type</td>
                                            <td>
                                                        <code>&quot;private&quot; | &quot;thread&quot; | &quot;thread-channel&quot;</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>The message type: private, thread, or thread-channel.</li>
</ul>

                                            </td>
                                        </tr>
                                        <tr>
                                                <td>callback</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/function" target="_blank" >function</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>Receives an updated map of reply counts whenever changes occur.</li>
</ul>

                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >void</a></code>

                        </div>
                            <div class="io-description">
                                <p>A function to unsubscribe from all snapshot listeners.</p>

                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="mapMessagesDocs"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                        <span ><b>mapMessagesDocs</b></span>
                        <a href="#mapMessagesDocs"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>mapMessagesDocs(snapshot: <a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank">any</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="276"
                                    class="link-to-prism">src/app/message.service.ts:276</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Maps the snapshot docs to a messages array with IDs and data.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>snapshot</td>
                                            <td>
                                                            <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>any[]</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="mapMessagesOnce"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                        <span ><b>mapMessagesOnce</b></span>
                        <a href="#mapMessagesOnce"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>mapMessagesOnce(snapshot: <a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank">any</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="209"
                                    class="link-to-prism">src/app/message.service.ts:209</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Maps query snapshot docs to an array of messages with converted timestamps.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>snapshot</td>
                                            <td>
                                                            <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>any[]</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="mapPrivateMessages"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                        <span ><b>mapPrivateMessages</b></span>
                        <a href="#mapPrivateMessages"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>mapPrivateMessages(snapshot: <a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank">any</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="597"
                                    class="link-to-prism">src/app/message.service.ts:597</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Maps snapshot docs to an array of message objects, converting the timestamp field.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>snapshot</td>
                                            <td>
                                                            <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>any[]</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="mapReplySnapshot"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                        <span ><b>mapReplySnapshot</b></span>
                        <a href="#mapReplySnapshot"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>mapReplySnapshot(snapshot: <a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank">any</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="484"
                                    class="link-to-prism">src/app/message.service.ts:484</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Extracts the count and lastResponseTime from the given snapshot.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>snapshot</td>
                                            <td>
                                                            <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>literal type</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="mapSnapshotDocs"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                        <span ><b>mapSnapshotDocs</b></span>
                        <a href="#mapSnapshotDocs"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>mapSnapshotDocs(snapshot: <a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank">any</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="317"
                                    class="link-to-prism">src/app/message.service.ts:317</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Maps snapshot docs into a messages array with id and data merged.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>snapshot</td>
                                            <td>
                                                            <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>any[]</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="mapThreadSnapshot"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                        <span ><b>mapThreadSnapshot</b></span>
                        <a href="#mapThreadSnapshot"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>mapThreadSnapshot(snapshot: <a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank">any</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="828"
                                    class="link-to-prism">src/app/message.service.ts:828</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Maps the snapshot docs to a messages array, adjusting the parentId when it equals the threadId.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>snapshot</td>
                                            <td>
                                                            <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>any[]</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="mergeNewAndExistingEmojis"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                        <span ><b>mergeNewAndExistingEmojis</b></span>
                        <a href="#mergeNewAndExistingEmojis"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>mergeNewAndExistingEmojis(newEmojis: string[], existing: string[])</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="878"
                                    class="link-to-prism">src/app/message.service.ts:878</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Merges new emojis with existing ones, removes duplicates, and limits the result to 2 items.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>newEmojis</td>
                                            <td>
                                                        <code>string[]</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>existing</td>
                                            <td>
                                                        <code>string[]</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>string[]</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="onAllUsersChanged"></a>
                    <span class="name">
                            <span class="modifier">Public</span>
                        <span ><b>onAllUsersChanged</b></span>
                        <a href="#onAllUsersChanged"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>onAllUsersChanged(callback: (allUsers: any[]) => void)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="1045"
                                    class="link-to-prism">src/app/message.service.ts:1045</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>callback</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/function" target="_blank" >function</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >void</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="onRecipientStatusChanged"></a>
                    <span class="name">
                            <span class="modifier">Public</span>
                        <span ><b>onRecipientStatusChanged</b></span>
                        <a href="#onRecipientStatusChanged"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>onRecipientStatusChanged(recipientId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, callback: (data: literal type) => void)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="998"
                                    class="link-to-prism">src/app/message.service.ts:998</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>onRecipientStatusChanged listens for changes to the recipient&#39;s user doc
in Firestore and notifies the callback about their status, avatar, name, and email.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                                <td>Description</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>recipientId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>The Firestore user ID of the recipient.</li>
</ul>

                                            </td>
                                        </tr>
                                        <tr>
                                                <td>callback</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/function" target="_blank" >function</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>A function receiving the updated status data (online, avatar, name, email).</li>
</ul>

                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >void</a></code>

                        </div>
                            <div class="io-description">
                                <p>A function to unsubscribe from the snapshot listener.</p>

                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="resolveFieldName"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                        <span ><b>resolveFieldName</b></span>
                        <a href="#resolveFieldName"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>resolveFieldName(type: "sent" | "received")</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="861"
                                    class="link-to-prism">src/app/message.service.ts:861</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Returns &#39;lastUsedEmojisSent&#39; or &#39;lastUsedEmojisReceived&#39; based on the given type.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>type</td>
                                            <td>
                                                        <code>&quot;sent&quot; | &quot;received&quot;</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="saveLastUsedEmojis"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>saveLastUsedEmojis</b></span>
                        <a href="#saveLastUsedEmojis"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>saveLastUsedEmojis(conversationId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, newEmojis: string[], type: "sent" | "received")</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="720"
                                    class="link-to-prism">src/app/message.service.ts:720</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>saveLastUsedEmojis merges the given newEmojis with existing stored emojis
in a &#39;messages&#39; doc for a specific conversation, limited to 2 items max.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                                <td>Description</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>conversationId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>The doc ID for the conversation in Firestore.</li>
</ul>

                                            </td>
                                        </tr>
                                        <tr>
                                                <td>newEmojis</td>
                                            <td>
                                                        <code>string[]</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>An array of new emoji strings to store.</li>
</ul>

                                            </td>
                                        </tr>
                                        <tr>
                                                <td>type</td>
                                            <td>
                                                        <code>&quot;sent&quot; | &quot;received&quot;</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>Either &#39;sent&#39; or &#39;received&#39;, specifying which field to update.</li>
</ul>

                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;void&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="saveLastUsedThreadEmojis"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>saveLastUsedThreadEmojis</b></span>
                        <a href="#saveLastUsedThreadEmojis"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>saveLastUsedThreadEmojis(threadId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, newEmojis: string[], type: "sent" | "received")</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="848"
                                    class="link-to-prism">src/app/message.service.ts:848</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>saveLastUsedThreadEmojis merges the given new emojis into lastUsedEmojisSent or
lastUsedEmojisReceived fields on a &quot;messages&quot; doc representing a thread&#39;s parent.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                                <td>Description</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>threadId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>The doc ID representing the parent thread message in Firestore.</li>
</ul>

                                            </td>
                                        </tr>
                                        <tr>
                                                <td>newEmojis</td>
                                            <td>
                                                        <code>string[]</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>The new emoji strings to store.</li>
</ul>

                                            </td>
                                        </tr>
                                        <tr>
                                                <td>type</td>
                                            <td>
                                                        <code>&quot;sent&quot; | &quot;received&quot;</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>&#39;sent&#39; or &#39;received&#39; determines which field to update.</li>
</ul>

                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;void&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="sendBroadcastMessage"></a>
                    <span class="name">
                            <span class="modifier">Public</span>
                            <span class="modifier">Async</span>
                        <span ><b>sendBroadcastMessage</b></span>
                        <a href="#sendBroadcastMessage"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>sendBroadcastMessage(data: <a href="../interfaces/BroadcastMessageData.html" target="_self">BroadcastMessageData</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="1097"
                                    class="link-to-prism">src/app/message.service.ts:1097</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Saves a broadcast message in Firestore with &quot;broadcast&quot; type.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                                <td>Description</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>data</td>
                                            <td>
                                                            <code><a href="../interfaces/BroadcastMessageData.html" target="_self" >BroadcastMessageData</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>The broadcast message data</li>
</ul>

                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;string&gt;</code>

                        </div>
                            <div class="io-description">
                                <p>A promise resolving to the Firestore doc ID</p>

                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="sendChannelMessage"></a>
                    <span class="name">
                            <span class="modifier">Public</span>
                            <span class="modifier">Async</span>
                        <span ><b>sendChannelMessage</b></span>
                        <a href="#sendChannelMessage"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>sendChannelMessage(data: <a href="../interfaces/ChannelMessageData.html" target="_self">ChannelMessageData</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="1077"
                                    class="link-to-prism">src/app/message.service.ts:1077</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Creates a message in Firestore with &quot;channel&quot; type.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                                <td>Description</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>data</td>
                                            <td>
                                                            <code><a href="../interfaces/ChannelMessageData.html" target="_self" >ChannelMessageData</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>The channel message data</li>
</ul>

                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;string&gt;</code>

                        </div>
                            <div class="io-description">
                                <p>A promise resolving to the Firestore doc ID</p>

                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="sendMessage"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>sendMessage</b></span>
                        <a href="#sendMessage"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>sendMessage(data: literal type)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="80"
                                    class="link-to-prism">src/app/message.service.ts:80</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Demonstration of splitting a larger method (sendMessage) into helper functions.
No logic is changed  it&#39;s just spread across smaller functions for clarity.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>data</td>
                                            <td>
                                                        <code>literal type</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;string&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="setUserOnlineStatus"></a>
                    <span class="name">
                            <span class="modifier">Public</span>
                            <span class="modifier">Async</span>
                        <span ><b>setUserOnlineStatus</b></span>
                        <a href="#setUserOnlineStatus"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>setUserOnlineStatus(userId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, isOnline: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank">boolean</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="1064"
                                    class="link-to-prism">src/app/message.service.ts:1064</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>userId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>isOnline</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank" >boolean</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;void&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="storeThreadEmojis"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                            <span class="modifier">Async</span>
                        <span ><b>storeThreadEmojis</b></span>
                        <a href="#storeThreadEmojis"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>storeThreadEmojis(threadId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, field: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, emojis: string[])</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="886"
                                    class="link-to-prism">src/app/message.service.ts:886</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Stores the merged emojis into the specified field of the Firestore doc.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>threadId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>field</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>emojis</td>
                                            <td>
                                                        <code>string[]</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;void&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="updateMessage"></a>
                    <span class="name">
                            <span class="modifier">Public</span>
                            <span class="modifier">Async</span>
                        <span ><b>updateMessage</b></span>
                        <a href="#updateMessage"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>updateMessage(messageId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, updatedData: Partial<any>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="651"
                                    class="link-to-prism">src/app/message.service.ts:651</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>updateMessage modifies an existing message doc by ID, merging new data fields like edited content.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                                <td>Description</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>messageId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>The Firestore doc ID of the message to be updated.</li>
</ul>

                                            </td>
                                        </tr>
                                        <tr>
                                                <td>updatedData</td>
                                            <td>
                                                        <code>Partial&lt;any&gt;</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>A partial object with the fields to be updated, e.g. { content: newContent }.</li>
</ul>

                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;void&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="updateReplyCount"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>updateReplyCount</b></span>
                        <a href="#updateReplyCount"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>updateReplyCount(parentMessageId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, type: "private" | "thread" | "thread-channel")</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="332"
                                    class="link-to-prism">src/app/message.service.ts:332</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>updateReplyCount recalculates how many replies exist for a given parentMessageId,
by counting the messages in Firestore that reference it. The updated count is stored
in the &#39;replyCount&#39; field on the parent document.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                                <td>Description</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>parentMessageId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>The ID of the parent message in Firestore.</li>
</ul>

                                            </td>
                                        </tr>
                                        <tr>
                                                <td>type</td>
                                            <td>
                                                        <code>&quot;private&quot; | &quot;thread&quot; | &quot;thread-channel&quot;</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>The message type: private, thread, or thread-channel.</li>
</ul>

                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;void&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="updateReplyCountInParent"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                            <span class="modifier">Async</span>
                        <span ><b>updateReplyCountInParent</b></span>
                        <a href="#updateReplyCountInParent"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>updateReplyCountInParent(ref: <a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank">any</a>, replyCount: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank">number</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="381"
                                    class="link-to-prism">src/app/message.service.ts:381</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Updates the parent document&#39;s &#39;replyCount&#39; field in Firestore.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>ref</td>
                                            <td>
                                                            <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>replyCount</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;void&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="updateThreadEmojisInDoc"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                            <span class="modifier">Async</span>
                        <span ><b>updateThreadEmojisInDoc</b></span>
                        <a href="#updateThreadEmojisInDoc"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>updateThreadEmojisInDoc(threadId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, emojis: literal type[])</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="786"
                                    class="link-to-prism">src/app/message.service.ts:786</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Updates the thread document in Firestore with the modified emojis array.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>threadId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>emojis</td>
                                            <td>
                                                        <code>literal type[]</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;void&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="updateThreadLastResponseTime"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>updateThreadLastResponseTime</b></span>
                        <a href="#updateThreadLastResponseTime"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>updateThreadLastResponseTime(threadId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="530"
                                    class="link-to-prism">src/app/message.service.ts:530</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>updateThreadLastResponseTime updates the lastResponseTime field of a &quot;thread&quot; document
to the serverTimestamp, typically when a new reply is added.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                                <td>Description</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>threadId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>The message doc ID representing the thread&#39;s parent message.</li>
</ul>

                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;void&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="validateThreadChannel"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                        <span ><b>validateThreadChannel</b></span>
                        <a href="#validateThreadChannel"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>validateThreadChannel(data: <a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank">any</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="101"
                                    class="link-to-prism">src/app/message.service.ts:101</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Throws an error if <code>type</code> is &#39;thread-channel&#39; but <code>threadChannelId</code> is missing.
This keeps the validation logic separate and more readable.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>data</td>
                                            <td>
                                                            <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >void</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
</section>

    </div>


    <div class="tab-pane fade  tab-source-code" id="source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { Injectable } from &#x27;@angular/core&#x27;;
import {
  Firestore,
  collection,
  addDoc,
  query,
  where,
  getDocs,
  doc,
  updateDoc,
  orderBy,
  getDoc,
  onSnapshot,
  setDoc,
  collectionData,
} from &#x27;@angular/fire/firestore&#x27;;
import { serverTimestamp } from &#x27;firebase/firestore&#x27;;
import { FirestoreMessageData } from &#x27;./message.models&#x27;;
import { Message } from &#x27;./message.models&#x27;;
import { MessageContent } from &#x27;./message.models&#x27;;
import { getAuth } from &#x27;firebase/auth&#x27;;
import { Observable } from &#x27;rxjs&#x27;;
import { BroadcastMessageData } from &#x27;./message.models&#x27;;
import { ChannelMessageData } from &#x27;./message.models&#x27;;

import { ChannelService } from &#x27;./channel.service&#x27;;
/**
 * ReplyCountsMap is used to store reply counts (plus the latest response time)
 * for multiple parent message IDs, used primarily for live updates.
 */
type ReplyCountsMap &#x3D; Record&lt;
  string,
  { count: number; lastResponseTime: Date | null }
&gt;;

/**
 * MessageType enumerates the recognized message categories like private, thread, or thread-channel.
 */
type MessageType &#x3D; &#x27;text&#x27; | &#x27;private&#x27; | &#x27;thread&#x27; | &#x27;thread-channel&#x27;;

/**
 * MessageService handles sending, querying, and updating messages of
 * different types in Firestore. It also supports reply counting and
 * real-time updates of emojis and thread data.
 */
@Injectable({
  providedIn: &#x27;root&#x27;,
})
export class MessageService {
  constructor(
    private firestore: Firestore,
    private channelService: ChannelService
  ) {}

  /**
   * generateConversationId sorts two user IDs alphabetically, then joins them with an underscore
   * to produce a stable, unique conversation ID for private messages.
   *
   * @param userId1 - The first user ID.
   * @param userId2 - The second user ID.
   * @returns A string conversation ID for Firestore queries.
   */
  generateConversationId(userId1: string, userId2: string): string {
    return [userId1, userId2].sort().join(&#x27;_&#x27;);
  }

  /**
   * Demonstration of splitting a larger method (sendMessage) into helper functions.
   * No logic is changed  it&#x27;s just spread across smaller functions for clarity.
   */
  async sendMessage(data: {
    type: &#x27;thread&#x27; | &#x27;private&#x27; | &#x27;thread-channel&#x27;;
    threadChannelId?: string;
    conversationId?: string;
    channelId?: string;
    content: MessageContent;
    senderId: string;
    parentId?: string;
    senderName?: string;
    senderAvatar?: string;
    recipientId?: string;
  }): Promise&lt;string&gt; {
    this.validateThreadChannel(data);
    const messagePayload &#x3D; this.buildMessagePayload(data);
    return await this.commitMessage(messagePayload);
  }

  /**
   * Throws an error if &#x60;type&#x60; is &#x27;thread-channel&#x27; but &#x60;threadChannelId&#x60; is missing.
   * This keeps the validation logic separate and more readable.
   */
  private validateThreadChannel(data: any): void {
    if (data.type &#x3D;&#x3D;&#x3D; &#x27;thread-channel&#x27; &amp;&amp; !data.threadChannelId) {
      throw new Error(&#x27;Missing &#x60;threadChannelId&#x60; for thread-channel message&#x27;);
    }
  }

  /**
   * Creates the final message object that will be stored in Firestore.
   * By separating this out, your main method stays concise.
   */
  private buildMessagePayload(data: any): any {
    return {
      ...data,
      timestamp: serverTimestamp(),
      channelId: data.channelId ?? null,
      threadChannelId: data.threadChannelId ?? null,
    };
  }

  /**
   * Adds the message document to Firestore and returns its doc ID.
   * Extracting this step clarifies exactly where the database write happens.
   */
  private async commitMessage(payload: any): Promise&lt;string&gt; {
    const messagesRef &#x3D; collection(this.firestore, &#x27;messages&#x27;);
    const docRef &#x3D; await addDoc(messagesRef, payload);
    return docRef.id;
  }

  /**
   * getMessages can be used to fetch messages for a channel or a specific threadChannelId.
   * It returns a live Observable of message arrays.
   *
   * @param channelId - The ID of the channel.
   * @param threadChannelId - If provided, only messages for that thread-channel are fetched.
   * @returns An Observable of message arrays.
   */
  getMessages(channelId: string, threadChannelId?: string): Observable&lt;any[]&gt; {
    const messagesCollection &#x3D; collection(this.firestore, &#x27;messages&#x27;);
    let q;

    if (threadChannelId) {
      // Only thread-channel messages
      q &#x3D; query(
        messagesCollection,
        where(&#x27;threadChannelId&#x27;, &#x27;&#x3D;&#x3D;&#x27;, threadChannelId),
        orderBy(&#x27;timestamp&#x27;, &#x27;asc&#x27;)
      );
    } else {
      // Normal channel messages (no threadChannelId)
      q &#x3D; query(
        messagesCollection,
        where(&#x27;channelId&#x27;, &#x27;&#x3D;&#x3D;&#x27;, channelId),
        where(&#x27;threadChannelId&#x27;, &#x27;&#x3D;&#x3D;&#x27;, null),
        orderBy(&#x27;timestamp&#x27;, &#x27;asc&#x27;)
      );
    }

    return collectionData(q, { idField: &#x27;id&#x27; }) as Observable&lt;any[]&gt;;
  }
  /**
   * getMessagesOnce performs a one-time Firestore query for messages of a specific type
   * (private, thread, or thread-channel) and optionally filters by a conversation or thread ID.
   *
   * @param type - The message category: &#x27;private&#x27; | &#x27;thread&#x27; | &#x27;thread-channel&#x27;.
   * @param id - The optional ID to filter by (e.g., conversationId or threadChannelId).
   * @returns A promise that resolves to an array of messages.
   */
  async getMessagesOnce(
    type: &#x27;private&#x27; | &#x27;thread&#x27; | &#x27;thread-channel&#x27;,
    id?: string
  ): Promise&lt;any[]&gt; {
    const queryRef &#x3D; id
      ? this.buildQueryForId(type, id)
      : this.buildQueryByType(type);
    const snapshot &#x3D; await getDocs(queryRef);
    return this.mapMessagesOnce(snapshot);
  }

  /** Builds a Firestore query for a given type + ID (conversation or thread). */
  private buildQueryForId(
    type: &#x27;private&#x27; | &#x27;thread&#x27; | &#x27;thread-channel&#x27;,
    id: string
  ) {
    const messagesRef &#x3D; collection(this.firestore, &#x27;messages&#x27;);
    let filterField &#x3D; &#x27;&#x27;;
    if (type &#x3D;&#x3D;&#x3D; &#x27;private&#x27;) filterField &#x3D; &#x27;conversationId&#x27;;
    else if (type &#x3D;&#x3D;&#x3D; &#x27;thread-channel&#x27;) filterField &#x3D; &#x27;threadChannelId&#x27;;
    else filterField &#x3D; &#x27;threadId&#x27;;
    return query(
      messagesRef,
      where(&#x27;type&#x27;, &#x27;&#x3D;&#x3D;&#x27;, type),
      where(filterField, &#x27;&#x3D;&#x3D;&#x27;, id),
      orderBy(&#x27;timestamp&#x27;, &#x27;asc&#x27;)
    );
  }

  /** Builds a Firestore query if no ID is given, just filtering by type. */
  private buildQueryByType(type: &#x27;private&#x27; | &#x27;thread&#x27; | &#x27;thread-channel&#x27;) {
    const messagesRef &#x3D; collection(this.firestore, &#x27;messages&#x27;);
    return query(
      messagesRef,
      where(&#x27;type&#x27;, &#x27;&#x3D;&#x3D;&#x27;, type),
      orderBy(&#x27;timestamp&#x27;, &#x27;asc&#x27;)
    );
  }

  /** Maps query snapshot docs to an array of messages with converted timestamps. */
  private mapMessagesOnce(snapshot: any): any[] {
    return snapshot.docs.map((docSnap: any) &#x3D;&gt; {
      const data &#x3D; docSnap.data();
      return {
        id: docSnap.id,
        ...data,
        time: this.convertToTime(data[&#x27;timestamp&#x27;]),
      };
    });
  }

  /**
   * listenMessages sets up a snapshot listener for live updates on messages
   * matching the specified type (private, thread, or thread-channel) and ID.
   *
   * @param type - The message type category.
   * @param id - The conversation or thread ID to filter by.
   * @param callback - A function invoked whenever new snapshot data arrives.
   * @returns A function to unsubscribe from the snapshot listener.
   */
  listenMessages(
    type: &#x27;private&#x27; | &#x27;thread&#x27; | &#x27;thread-channel&#x27;,
    id: string,
    callback: (messages: any[]) &#x3D;&gt; void
  ): () &#x3D;&gt; void {
    const queryRef &#x3D; this.buildListenMessagesQuery(type, id);
    if (!queryRef) return () &#x3D;&gt; {};
    const unsubscribe &#x3D; onSnapshot(
      queryRef,
      (snapshot) &#x3D;&gt; callback(this.mapMessagesDocs(snapshot)),
      () &#x3D;&gt; {}
    );
    return unsubscribe;
  }

  /** Builds the Firestore query based on message type and ID. */
  private buildListenMessagesQuery(
    type: &#x27;private&#x27; | &#x27;thread&#x27; | &#x27;thread-channel&#x27;,
    id: string
  ) {
    const messagesRef &#x3D; collection(this.firestore, &#x27;messages&#x27;);
    if (type &#x3D;&#x3D;&#x3D; &#x27;private&#x27;) {
      return query(
        messagesRef,
        where(&#x27;type&#x27;, &#x27;&#x3D;&#x3D;&#x27;, &#x27;private&#x27;),
        where(&#x27;conversationId&#x27;, &#x27;&#x3D;&#x3D;&#x27;, id),
        orderBy(&#x27;timestamp&#x27;, &#x27;asc&#x27;)
      );
    } else if (type &#x3D;&#x3D;&#x3D; &#x27;thread&#x27;) {
      return query(
        messagesRef,
        where(&#x27;type&#x27;, &#x27;&#x3D;&#x3D;&#x27;, &#x27;thread&#x27;),
        where(&#x27;threadId&#x27;, &#x27;&#x3D;&#x3D;&#x27;, id),
        orderBy(&#x27;timestamp&#x27;, &#x27;asc&#x27;)
      );
    } else if (type &#x3D;&#x3D;&#x3D; &#x27;thread-channel&#x27;) {
      return query(
        messagesRef,
        where(&#x27;type&#x27;, &#x27;&#x3D;&#x3D;&#x27;, &#x27;thread-channel&#x27;),
        where(&#x27;threadChannelId&#x27;, &#x27;&#x3D;&#x3D;&#x27;, id),
        orderBy(&#x27;timestamp&#x27;, &#x27;asc&#x27;)
      );
    }
    return null;
  }

  /** Maps the snapshot docs to a messages array with IDs and data. */
  private mapMessagesDocs(snapshot: any): any[] {
    return snapshot.docs.map((docSnap: any) &#x3D;&gt; ({
      id: docSnap.id,
      ...docSnap.data(),
    }));
  }

  /**
   * listenForMessages sets up a Firestore query for messages with a specified type
   * (private, thread, or thread-channel) and a parentId or threadChannelId.
   *
   * @param type - One of the recognized message types.
   * @param parentId - The relevant parent ID (conversation, thread, or channel).
   * @param callback - Fired on every change, receiving the updated messages array.
   * @returns A function to unsubscribe from live updates.
   */
  listenForMessages(
    type: &#x27;private&#x27; | &#x27;thread&#x27; | &#x27;thread-channel&#x27;,
    parentId: string,
    callback: (messages: any[]) &#x3D;&gt; void
  ): () &#x3D;&gt; void {
    const queryRef &#x3D; this.buildListenForMessagesQuery(type, parentId);
    return onSnapshot(queryRef, (snap) &#x3D;&gt; callback(this.mapSnapshotDocs(snap)));
  }

  /** Constructs the Firestore query based on type and parentId, ordering by timestamp. */
  private buildListenForMessagesQuery(
    type: &#x27;private&#x27; | &#x27;thread&#x27; | &#x27;thread-channel&#x27;,
    parentId: string
  ) {
    const ref &#x3D; collection(this.firestore, &#x27;messages&#x27;);
    let baseQ &#x3D; query(ref, where(&#x27;type&#x27;, &#x27;&#x3D;&#x3D;&#x27;, type));
    if (type &#x3D;&#x3D;&#x3D; &#x27;thread-channel&#x27;) {
      baseQ &#x3D; query(baseQ, where(&#x27;threadChannelId&#x27;, &#x27;&#x3D;&#x3D;&#x27;, parentId));
    } else {
      baseQ &#x3D; query(baseQ, where(&#x27;parentId&#x27;, &#x27;&#x3D;&#x3D;&#x27;, parentId));
    }
    return query(baseQ, orderBy(&#x27;timestamp&#x27;, &#x27;asc&#x27;));
  }

  /** Maps snapshot docs into a messages array with id and data merged. */
  private mapSnapshotDocs(snapshot: any): any[] {
    return snapshot.docs.map((docSnap: any) &#x3D;&gt; ({
      id: docSnap.id,
      ...docSnap.data(),
    }));
  }

  /**
   * updateReplyCount recalculates how many replies exist for a given parentMessageId,
   * by counting the messages in Firestore that reference it. The updated count is stored
   * in the &#x27;replyCount&#x27; field on the parent document.
   *
   * @param parentMessageId - The ID of the parent message in Firestore.
   * @param type - The message type: private, thread, or thread-channel.
   */
  async updateReplyCount(
    parentMessageId: string,
    type: &#x27;private&#x27; | &#x27;thread&#x27; | &#x27;thread-channel&#x27;
  ): Promise&lt;void&gt; {
    const parentRef &#x3D; doc(this.firestore, &#x27;messages&#x27;, parentMessageId);
    try {
      const parentDoc &#x3D; await this.getParentDocData(parentRef);
      if (!parentDoc) return; // Parent doc doesn&#x27;t exist
      // Read the current replyCount (kept to preserve original logic)
      const oldReplyCount &#x3D; parentDoc[&#x27;replyCount&#x27;] || 0;
      const filterField &#x3D; this.getFilterField(type);
      const newReplyCount &#x3D; await this.countFilteredReplies(
        filterField,
        parentMessageId
      );
      await this.updateReplyCountInParent(parentRef, newReplyCount);
    } catch (error) {
      // Intentionally empty to match original logic
    }
  }

  /** Fetches parent doc data from Firestore, or null if it doesn&#x27;t exist. */
  private async getParentDocData(ref: any): Promise&lt;any | null&gt; {
    const snapshot &#x3D; await getDoc(ref);
    return snapshot.exists() ? snapshot.data() : null;
  }

  /** Determines which field to filter by, based on message type. */
  private getFilterField(
    type: &#x27;private&#x27; | &#x27;thread&#x27; | &#x27;thread-channel&#x27;
  ): string {
    return type &#x3D;&#x3D;&#x3D; &#x27;thread-channel&#x27; ? &#x27;threadChannelId&#x27; : &#x27;parentId&#x27;;
  }

  /** Counts how many reply documents exist that match the given field and parent ID. */
  private async countFilteredReplies(
    field: string,
    parentId: string
  ): Promise&lt;number&gt; {
    const q &#x3D; query(
      collection(this.firestore, &#x27;messages&#x27;),
      where(field, &#x27;&#x3D;&#x3D;&#x27;, parentId),
      orderBy(&#x27;timestamp&#x27;, &#x27;asc&#x27;)
    );
    const snap &#x3D; await getDocs(q);
    return snap.size;
  }

  /** Updates the parent document&#x27;s &#x27;replyCount&#x27; field in Firestore. */
  private async updateReplyCountInParent(
    ref: any,
    replyCount: number
  ): Promise&lt;void&gt; {
    await updateDoc(ref, { replyCount });
  }

  /**
   * getReplyCountsForMessages loops over an array of message IDs and calculates how many
   * replies each has, returning an object keyed by messageId. Optionally updates the last
   * response time if a reply is found.
   *
   * @param messageIds - An array of Firestore doc IDs for parent messages.
   * @param type - The type used to identify the correct filter field in Firestore.
   * @returns A map of message IDs to reply counts and lastResponseTime.
   */
  async getReplyCountsForMessages(
    messageIds: string[],
    type: &#x27;private&#x27; | &#x27;thread&#x27; | &#x27;thread-channel&#x27;
  ): Promise&lt;ReplyCountsMap&gt; {
    const replyCounts: ReplyCountsMap &#x3D; {};
    const filterField &#x3D; this.getFilterFieldForReplies(type);
    for (const msgId of messageIds) {
      const { count, lastResponseTime } &#x3D; await this.fetchReplyCountAndTime(
        filterField,
        msgId
      );
      replyCounts[msgId] &#x3D; { count, lastResponseTime };
    }
    return replyCounts;
  }

  /** Returns the correct Firestore field for message replies based on the given type. */
  private getFilterFieldForReplies(
    type: &#x27;private&#x27; | &#x27;thread&#x27; | &#x27;thread-channel&#x27;
  ): string {
    return type &#x3D;&#x3D;&#x3D; &#x27;thread-channel&#x27; ? &#x27;threadChannelId&#x27; : &#x27;parentId&#x27;;
  }

  /** Fetches the reply count and the latest response time for a given messageId. */
  private async fetchReplyCountAndTime(
    field: string,
    messageId: string
  ): Promise&lt;{ count: number; lastResponseTime: Date | null }&gt; {
    const q &#x3D; query(
      collection(this.firestore, &#x27;messages&#x27;),
      where(field, &#x27;&#x3D;&#x3D;&#x27;, messageId),
      orderBy(&#x27;timestamp&#x27;, &#x27;asc&#x27;)
    );
    const snapshot &#x3D; await getDocs(q);
    const count &#x3D; snapshot.size;
    let lastResponseTime: Date | null &#x3D; null;
    if (count &gt; 0) {
      const lastDoc &#x3D; snapshot.docs[count - 1];
      const ts &#x3D; lastDoc.data()?.[&#x27;timestamp&#x27;];
      if (ts?.toDate) lastResponseTime &#x3D; ts.toDate();
    }
    return { count, lastResponseTime };
  }

  /**
   * loadReplyCountsLive sets up individual snapshot listeners for each parent messageId,
   * aggregating reply counts and last response times in a central object that&#x27;s passed to
   * the provided callback. Returns a function to unsubscribe all.
   *
   * @param messageIds - The IDs of parent messages to track.
   * @param type - The message type: private, thread, or thread-channel.
   * @param callback - Receives an updated map of reply counts whenever changes occur.
   * @returns A function to unsubscribe from all snapshot listeners.
   */
  loadReplyCountsLive(
    messageIds: string[],
    type: &#x27;private&#x27; | &#x27;thread&#x27; | &#x27;thread-channel&#x27;,
    callback: (replyCounts: ReplyCountsMap) &#x3D;&gt; void
  ): () &#x3D;&gt; void {
    if (!messageIds.length) return () &#x3D;&gt; {};
    const unsubscribes: Array&lt;() &#x3D;&gt; void&gt; &#x3D; [];
    const aggregator: ReplyCountsMap &#x3D; {};
    const filterField &#x3D; this.getReplyFilterField(type);

    messageIds.forEach((msgId) &#x3D;&gt; {
      const q &#x3D; query(
        collection(this.firestore, &#x27;messages&#x27;),
        where(filterField, &#x27;&#x3D;&#x3D;&#x27;, msgId),
        orderBy(&#x27;timestamp&#x27;, &#x27;asc&#x27;)
      );
      const unsubscribe &#x3D; onSnapshot(q, (snap) &#x3D;&gt; {
        aggregator[msgId] &#x3D; this.mapReplySnapshot(snap);
        callback({ ...aggregator });
      });
      unsubscribes.push(unsubscribe);
    });
    return () &#x3D;&gt; unsubscribes.forEach((fn) &#x3D;&gt; fn());
  }

  /** Returns the correct Firestore field (threadChannelId or parentId) for the given message type. */
  private getReplyFilterField(
    type: &#x27;private&#x27; | &#x27;thread&#x27; | &#x27;thread-channel&#x27;
  ): string {
    return type &#x3D;&#x3D;&#x3D; &#x27;thread-channel&#x27; ? &#x27;threadChannelId&#x27; : &#x27;parentId&#x27;;
  }

  /** Extracts the count and lastResponseTime from the given snapshot. */
  private mapReplySnapshot(snapshot: any): {
    count: number;
    lastResponseTime: Date | null;
  } {
    const count &#x3D; snapshot.size;
    let lastResponseTime: Date | null &#x3D; null;
    if (count &gt; 0) {
      const lastDoc &#x3D; snapshot.docs[count - 1];
      const ts &#x3D; lastDoc.data().timestamp;
      if (ts?.toDate) lastResponseTime &#x3D; ts.toDate();
    }
    return { count, lastResponseTime };
  }

  /**
   * listenForThreadDetails sets a snapshot listener on a single message doc in Firestore
   * (representing a thread), invoking the callback whenever the doc changes or is updated.
   *
   * @param threadId - The Firestore doc ID to watch.
   * @param callback - Called with the latest document data on changes.
   * @returns A function to unsubscribe from the snapshot.
   */
  listenForThreadDetails(
    threadId: string,
    callback: (data: any) &#x3D;&gt; void
  ): () &#x3D;&gt; void {
    const threadDocRef &#x3D; doc(this.firestore, &#x27;messages&#x27;, threadId);

    return onSnapshot(
      threadDocRef,
      (docSnap) &#x3D;&gt; {
        if (docSnap.exists()) {
          callback(docSnap.data());
        } else {
        }
      },
      (error) &#x3D;&gt; {}
    );
  }

  /**
   * updateThreadLastResponseTime updates the lastResponseTime field of a &quot;thread&quot; document
   * to the serverTimestamp, typically when a new reply is added.
   *
   * @param threadId - The message doc ID representing the thread&#x27;s parent message.
   */
  async updateThreadLastResponseTime(threadId: string): Promise&lt;void&gt; {
    const messageRef &#x3D; doc(this.firestore, &#x27;messages&#x27;, threadId);
    await updateDoc(messageRef, {
      lastResponseTime: serverTimestamp(),
    });
  }

  /**
   * getMessage retrieves a single message document by ID from Firestore,
   * converting its Firestore timestamp to a JavaScript Date.
   *
   * @param type - The message type (unused in logic, can be for debugging/logging).
   * @param messageId - The Firestore doc ID of the message.
   * @returns A message object with an additional &#x60;timestamp&#x60; as a JS Date, or null if not found.
   */
  async getMessage(
    type: &#x27;private&#x27; | &#x27;channel&#x27; | &#x27;thread&#x27; | &#x27;thread-channel&#x27;,
    messageId: string
  ): Promise&lt;Message | null&gt; {
    try {
      const docRef &#x3D; doc(this.firestore, &#x27;messages&#x27;, messageId);
      const docSnap &#x3D; await getDoc(docRef);

      if (docSnap.exists()) {
        const data &#x3D; docSnap.data();
        return {
          ...data,
          id: docSnap.id,
          timestamp: data[&#x27;timestamp&#x27;]?.toDate(),
        } as Message;
      }
      return null;
    } catch (error) {
      return null;
    }
  }

  /**
   * getPrivateMessagesLive attaches a snapshot listener to private messages
   * within a conversationId, sorted ascending by timestamp.
   *
   * @param conversationId - The ID of the private conversation to track.
   * @param callback - Invoked whenever snapshot changes with updated messages array.
   * @returns An unsubscribe function.
   */
  getPrivateMessagesLive(
    conversationId: string,
    callback: (messages: any[]) &#x3D;&gt; void
  ): () &#x3D;&gt; void {
    const queryRef &#x3D; this.buildPrivateMessagesQuery(conversationId);
    const unsubscribe &#x3D; onSnapshot(queryRef, (snap) &#x3D;&gt; {
      callback(this.mapPrivateMessages(snap));
    });
    return unsubscribe;
  }

  /** Builds the Firestore query for private messages in a specific conversation. */
  private buildPrivateMessagesQuery(conversationId: string) {
    return query(
      collection(this.firestore, &#x27;messages&#x27;),
      where(&#x27;type&#x27;, &#x27;&#x3D;&#x3D;&#x27;, &#x27;private&#x27;),
      where(&#x27;conversationId&#x27;, &#x27;&#x3D;&#x3D;&#x27;, conversationId),
      orderBy(&#x27;timestamp&#x27;, &#x27;asc&#x27;)
    );
  }

  /** Maps snapshot docs to an array of message objects, converting the timestamp field. */
  private mapPrivateMessages(snapshot: any): any[] {
    return snapshot.docs.map((docSnap: any) &#x3D;&gt; {
      const data &#x3D; docSnap.data();
      return {
        ...data,
        id: docSnap.id,
        time: this.convertToTime(data[&#x27;timestamp&#x27;]),
      };
    });
  }

  /**
   * convertToTime takes a Firestore timestamp or numeric value and returns a
   * localized time string (HH:MM) in &#x27;de-DE&#x27; format.
   *
   * @param timestamp - The Firestore timestamp or numeric timestamp in milliseconds.
   * @returns A string with hour:minute.
   */
  convertToTime(timestamp: any): string {
    if (!timestamp) return &#x27;&#x27;;
    const date &#x3D; timestamp?.seconds
      ? new Date(timestamp.seconds * 1000)
      : new Date(timestamp);
    return date.toLocaleTimeString(&#x27;de-DE&#x27;, {
      hour: &#x27;2-digit&#x27;,
      minute: &#x27;2-digit&#x27;,
    });
  }

  /**
   * convertToDate attempts to convert an unknown timestamp input to a JavaScript Date,
   * returning null if unable. Suitable for Firestore docs that store Timestamps or numbers.
   *
   * @param timestamp - Possibly a Firestore timestamp, a Date, or numeric.
   * @returns A Date object or null on failure.
   */
  public convertToDate(timestamp: any): Date | null {
    if (!timestamp) return null;
    if (timestamp.toDate) {
      return timestamp.toDate();
    }
    if (timestamp instanceof Date) {
      return timestamp;
    }
    const parsed &#x3D; new Date(timestamp);
    return isNaN(parsed.getTime()) ? null : parsed;
  }

  /**
   * updateMessage modifies an existing message doc by ID, merging new data fields like edited content.
   *
   * @param messageId - The Firestore doc ID of the message to be updated.
   * @param updatedData - A partial object with the fields to be updated, e.g. { content: newContent }.
   */
  public async updateMessage(
    messageId: string,
    updatedData: Partial&lt;any&gt;
  ): Promise&lt;void&gt; {
    const msgRef &#x3D; doc(this.firestore, &#x27;messages&#x27;, messageId);
    await updateDoc(msgRef, updatedData);
  }

  /**
   * listenForEmojiUpdates attaches a listener to a single messages document in Firestore,
   * typically used for saving last-used emojis for conversation references.
   *
   * @param conversationId - The Firestore doc ID for the conversation&#x27;s &quot;messages&quot; doc.
   * @param callback - Invoked with two arrays: the last used &#x27;sent&#x27; and &#x27;received&#x27; emojis.
   * @returns A function to unsubscribe from snapshot updates.
   */
  listenForEmojiUpdates(
    conversationId: string,
    callback: (sent: string[], received: string[]) &#x3D;&gt; void
  ): () &#x3D;&gt; void {
    if (!conversationId) return () &#x3D;&gt; {};

    const docRef &#x3D; doc(this.firestore, &#x27;messages&#x27;, conversationId);
    return onSnapshot(docRef, (snapshot) &#x3D;&gt; {
      if (!snapshot.exists()) {
        callback([], []);
        return;
      }
      const data &#x3D; snapshot.data() || {};
      const sentEmojis &#x3D; data[&#x27;lastUsedEmojisSent&#x27;]?.slice(0, 2) || [];
      const receivedEmojis &#x3D; data[&#x27;lastUsedEmojisReceived&#x27;]?.slice(0, 2) || [];
      callback(sentEmojis, receivedEmojis);
    });
  }

  /**
   * getLastUsedEmojis loads the last-used emojis array (either &#x27;sent&#x27; or &#x27;received&#x27;) from
   * a conversation doc in Firestore.
   *
   * @param conversationId - The Firestore doc ID for the conversation.
   * @param type - &#x27;sent&#x27; or &#x27;received&#x27;, specifying which field to read.
   * @returns An array of up to 2 emojis if they exist.
   */
  async getLastUsedEmojis(
    conversationId: string,
    type: &#x27;sent&#x27; | &#x27;received&#x27;
  ): Promise&lt;string[]&gt; {
    if (!conversationId) return [];

    const docRef &#x3D; doc(this.firestore, &#x27;messages&#x27;, conversationId);
    const docSnap &#x3D; await getDoc(docRef);
    if (!docSnap.exists()) {
      return [];
    }
    const data &#x3D; docSnap.data() || {};
    const fieldName &#x3D;
      type &#x3D;&#x3D;&#x3D; &#x27;sent&#x27; ? &#x27;lastUsedEmojisSent&#x27; : &#x27;lastUsedEmojisReceived&#x27;;
    const emojis &#x3D; data[fieldName] || [];
    return emojis.slice(0, 2);
  }

  /**
   * saveLastUsedEmojis merges the given newEmojis with existing stored emojis
   * in a &#x27;messages&#x27; doc for a specific conversation, limited to 2 items max.
   *
   * @param conversationId - The doc ID for the conversation in Firestore.
   * @param newEmojis - An array of new emoji strings to store.
   * @param type - Either &#x27;sent&#x27; or &#x27;received&#x27;, specifying which field to update.
   */
  async saveLastUsedEmojis(
    conversationId: string,
    newEmojis: string[],
    type: &#x27;sent&#x27; | &#x27;received&#x27;
  ): Promise&lt;void&gt; {
    if (!conversationId) return;
    const docRef &#x3D; doc(this.firestore, &#x27;messages&#x27;, conversationId);

    const fieldName &#x3D;
      type &#x3D;&#x3D;&#x3D; &#x27;sent&#x27; ? &#x27;lastUsedEmojisSent&#x27; : &#x27;lastUsedEmojisReceived&#x27;;
    const docSnap &#x3D; await getDoc(docRef);
    let existing: string[] &#x3D; [];
    if (docSnap.exists()) {
      existing &#x3D; docSnap.data()?.[fieldName] || [];
    }
    // Combine new + existing, remove duplicates, limit to 2
    const merged &#x3D; [...new Set([...newEmojis, ...existing])].slice(0, 2);
    await setDoc(docRef, { [fieldName]: merged }, { merge: true });
  }

  /**
   * addEmojiToThreadMessage increments or adds an emoji (by &#x27;emoji&#x27; string) within a thread&#x27;s
   * content.emojis array. Then, it updates lastUsedEmojis in Firestore as &#x27;sent&#x27; or &#x27;received&#x27;.
   *
   * @param threadId - The doc ID representing this thread message in Firestore.
   * @param emoji - The new emoji to add or increment.
   * @param senderId - The ID of the user sending the emoji, used to decide &#x27;sent&#x27; or &#x27;received&#x27;.
   */
  async addEmojiToThreadMessage(
    threadId: string,
    emoji: string,
    senderId: string
  ): Promise&lt;void&gt; {
    const emojis &#x3D; await this.fetchThreadEmojis(threadId);
    this.incrementOrAddEmoji(emojis, emoji);
    await this.updateThreadEmojisInDoc(threadId, emojis);
    const type &#x3D; senderId &#x3D;&#x3D;&#x3D; getAuth().currentUser?.uid ? &#x27;sent&#x27; : &#x27;received&#x27;;
    await this.saveLastUsedEmojis(threadId, [emoji], type);
  }

  /**
   * Fetches the current list of emojis from the thread&#x27;s Firestore document,
   * returning an array of { emoji, count } objects.
   */
  private async fetchThreadEmojis(
    threadId: string
  ): Promise&lt;{ emoji: string; count: number }[]&gt; {
    const ref &#x3D; doc(this.firestore, &#x27;messages&#x27;, threadId);
    const snap &#x3D; await getDoc(ref);
    if (!snap.exists()) return [];
    const data &#x3D; snap.data() as FirestoreMessageData; // Use your interface
    return data.content?.emojis || [];
  }

  /** Increments the count of an existing emoji or adds it if not found. */
  private incrementOrAddEmoji(
    emojis: { emoji: string; count: number }[],
    newEmoji: string
  ): void {
    const existing &#x3D; emojis.find((e) &#x3D;&gt; e.emoji &#x3D;&#x3D;&#x3D; newEmoji);
    existing
      ? (existing.count +&#x3D; 1)
      : emojis.push({ emoji: newEmoji, count: 1 });
  }

  /** Updates the thread document in Firestore with the modified emojis array. */
  private async updateThreadEmojisInDoc(
    threadId: string,
    emojis: { emoji: string; count: number }[]
  ): Promise&lt;void&gt; {
    const ref &#x3D; doc(this.firestore, &#x27;messages&#x27;, threadId);
    await updateDoc(ref, { &#x27;content.emojis&#x27;: emojis });
  }

  /**
   * getThreadMessagesLive attaches a snapshot listener for real-time updates
   * to a &#x27;thread&#x27; type message set, filtered by threadId, sorted by ascending timestamp.
   *
   * @param threadId - The ID that identifies this thread in Firestore.
   * @param callback - Invoked with an array of messages every time there&#x27;s a snapshot update.
   * @returns An unsubscribe function.
   */
  getThreadMessagesLive(
    threadId: string,
    callback: (messages: any[]) &#x3D;&gt; void
  ): () &#x3D;&gt; void {
    if (!threadId) return () &#x3D;&gt; {};
    const queryRef &#x3D; this.buildThreadMessagesQuery(threadId);
    const unsubscribe &#x3D; onSnapshot(
      queryRef,
      (snap) &#x3D;&gt; callback(this.mapThreadSnapshot(snap)),
      () &#x3D;&gt; {}
    );
    return unsubscribe;
  }

  /** Builds the Firestore query to retrieve &#x27;thread&#x27;-type messages sorted by timestamp. */
  private buildThreadMessagesQuery(threadId: string) {
    const ref &#x3D; collection(this.firestore, &#x27;messages&#x27;);
    return query(
      ref,
      where(&#x27;type&#x27;, &#x27;&#x3D;&#x3D;&#x27;, &#x27;thread&#x27;),
      where(&#x27;threadId&#x27;, &#x27;&#x3D;&#x3D;&#x27;, threadId),
      orderBy(&#x27;timestamp&#x27;, &#x27;asc&#x27;)
    );
  }

  /** Maps the snapshot docs to a messages array, adjusting the parentId when it equals the threadId. */
  private mapThreadSnapshot(snapshot: any): any[] {
    return snapshot.docs.map((docSnap: any) &#x3D;&gt; {
      const data &#x3D; docSnap.data();
      return {
        id: docSnap.id,
        ...data,
        parentId:
          data[&#x27;parentId&#x27;] !&#x3D;&#x3D; data[&#x27;threadId&#x27;] ? data[&#x27;parentId&#x27;] : null,
      };
    });
  }

  /**
   * saveLastUsedThreadEmojis merges the given new emojis into lastUsedEmojisSent or
   * lastUsedEmojisReceived fields on a &quot;messages&quot; doc representing a thread&#x27;s parent.
   *
   * @param threadId - The doc ID representing the parent thread message in Firestore.
   * @param newEmojis - The new emoji strings to store.
   * @param type - &#x27;sent&#x27; or &#x27;received&#x27; determines which field to update.
   */
  async saveLastUsedThreadEmojis(
    threadId: string,
    newEmojis: string[],
    type: &#x27;sent&#x27; | &#x27;received&#x27;
  ): Promise&lt;void&gt; {
    if (!threadId) return;
    const field &#x3D; this.resolveFieldName(type);
    const existing &#x3D; await this.getExistingThreadEmojis(threadId, field);
    const updated &#x3D; this.mergeNewAndExistingEmojis(newEmojis, existing);
    await this.storeThreadEmojis(threadId, field, updated);
  }

  /** Returns &#x27;lastUsedEmojisSent&#x27; or &#x27;lastUsedEmojisReceived&#x27; based on the given type. */
  private resolveFieldName(type: &#x27;sent&#x27; | &#x27;received&#x27;): string {
    return type &#x3D;&#x3D;&#x3D; &#x27;sent&#x27; ? &#x27;lastUsedEmojisSent&#x27; : &#x27;lastUsedEmojisReceived&#x27;;
  }

  /** Fetches the existing emojis array from the Firestore doc. If doc doesn&#x27;t exist, returns []. */
  private async getExistingThreadEmojis(
    threadId: string,
    field: string
  ): Promise&lt;string[]&gt; {
    const ref &#x3D; doc(this.firestore, &#x27;messages&#x27;, threadId);
    const snap &#x3D; await getDoc(ref);
    if (!snap.exists()) return [];
    const data &#x3D; snap.data() || {};
    return data[field] || [];
  }

  /** Merges new emojis with existing ones, removes duplicates, and limits the result to 2 items. */
  private mergeNewAndExistingEmojis(
    newEmojis: string[],
    existing: string[]
  ): string[] {
    return [...new Set([...newEmojis, ...existing])].slice(0, 2);
  }

  /** Stores the merged emojis into the specified field of the Firestore doc. */
  private async storeThreadEmojis(
    threadId: string,
    field: string,
    emojis: string[]
  ): Promise&lt;void&gt; {
    const ref &#x3D; doc(this.firestore, &#x27;messages&#x27;, threadId);
    await setDoc(ref, { [field]: emojis }, { merge: true });
  }

  /**
   * getLastUsedThreadEmojis fetches either the sent or received last-used emojis array
   * from a Firestore &#x27;messages&#x27; doc that holds a thread&#x27;s parent message. The doc must
   * store lastUsedEmojisSent or lastUsedEmojisReceived fields.
   *
   * @param threadId - The ID referencing the parent thread message doc.
   * @param type - &#x27;sent&#x27; or &#x27;received&#x27; deciding which field to read.
   * @returns Up to two emoji strings.
   */
  async getLastUsedThreadEmojis(
    threadId: string,
    type: &#x27;sent&#x27; | &#x27;received&#x27;
  ): Promise&lt;string[]&gt; {
    if (!threadId) return [];
    try {
      const ref &#x3D; doc(this.firestore, &#x27;messages&#x27;, threadId);
      const snap &#x3D; await getDoc(ref);
      if (!snap.exists()) return [];
      return this.extractThreadEmojis(snap.data(), type);
    } catch (error) {
      return [];
    }
  }

  /** Extracts the relevant emoji array (sent or received) from the document data, limited to 2 items. */
  private extractThreadEmojis(data: any, type: &#x27;sent&#x27; | &#x27;received&#x27;): string[] {
    const field &#x3D;
      type &#x3D;&#x3D;&#x3D; &#x27;sent&#x27; ? &#x27;lastUsedEmojisSent&#x27; : &#x27;lastUsedEmojisReceived&#x27;;
    const emojis &#x3D; data[field] || [];
    return emojis.slice(0, 2);
  }

  /**
   * listenForThreadEmojiUpdates attaches a real-time snapshot listener for a single
   * &#x27;messages&#x27; doc that represents the parent message of a thread, updating the
   * lastUsedEmojisSent and lastUsedEmojisReceived fields as changes occur.
   *
   * @param threadId - The Firestore doc ID for the parent thread message.
   * @param callback - Fired with two arrays: updatedEmojisSent and updatedEmojisReceived.
   * @returns A function to unsubscribe from the snapshot.
   */
  listenForThreadEmojiUpdates(
    threadId: string,
    callback: (sentEmojis: string[], receivedEmojis: string[]) &#x3D;&gt; void
  ): () &#x3D;&gt; void {
    if (!threadId) return () &#x3D;&gt; {};

    const docRef &#x3D; doc(this.firestore, &#x27;messages&#x27;, threadId);

    return onSnapshot(docRef, (docSnapshot) &#x3D;&gt; {
      if (docSnapshot.exists()) {
        const data &#x3D; docSnapshot.data() || {};
        const updatedEmojisSent &#x3D; data[&#x27;lastUsedEmojisSent&#x27;]?.slice(0, 2) || [];
        const updatedEmojisReceived &#x3D;
          data[&#x27;lastUsedEmojisReceived&#x27;]?.slice(0, 2) || [];

        callback(updatedEmojisSent, updatedEmojisReceived);
      }
    });
  }

  /**
   * Fetches all channel messages once, then filters out those
   * from channels where the current user isn&#x27;t a member.
   */
  async getChannelMessagesOnce(): Promise&lt;ChannelMessageData[]&gt; {
    // 1) Load all channels where user is a member
    const userChannels &#x3D; await this.channelService.getAllChannelsOnce();
    const userChannelIds &#x3D; new Set(userChannels.map((ch) &#x3D;&gt; ch.id));

    // 2) Retrieve all messages with channelId !&#x3D; null
    const messagesRef &#x3D; collection(this.firestore, &#x27;messages&#x27;);
    const q &#x3D; query(
      messagesRef,
      where(&#x27;channelId&#x27;, &#x27;!&#x3D;&#x27;, null),
      orderBy(&#x27;timestamp&#x27;, &#x27;asc&#x27;)
    );
    const snapshot &#x3D; await getDocs(q);

    // 3) Map Firestore docs to ChannelMessage
    const allChannelMessages: ChannelMessageData[] &#x3D; snapshot.docs.map(
      (doc) &#x3D;&gt; {
        return {
          id: doc.id,
          ...(doc.data() as ChannelMessageData), // cast to ensure TS sees &#x27;channelId&#x27;
        };
      }
    );

    // 4) Filter by membership
    return allChannelMessages.filter(
      (msg) &#x3D;&gt; msg.channelId &amp;&amp; userChannelIds.has(msg.channelId)
    );
  }

  /**
   * onRecipientStatusChanged listens for changes to the recipient&#x27;s user doc
   * in Firestore and notifies the callback about their status, avatar, name, and email.
   *
   * @param recipientId - The Firestore user ID of the recipient.
   * @param callback - A function receiving the updated status data (online, avatar, name, email).
   * @returns A function to unsubscribe from the snapshot listener.
   */
  public onRecipientStatusChanged(
    recipientId: string,
    callback: (data: {
      isOnline: boolean;
      avatarUrl: string;
      name: string;
      email: string;
    }) &#x3D;&gt; void
  ): () &#x3D;&gt; void {
    if (!recipientId) return () &#x3D;&gt; {};
    const docRef &#x3D; doc(this.firestore, &#x27;users&#x27;, recipientId);
    const unsubscribe &#x3D; onSnapshot(
      docRef,
      (snap) &#x3D;&gt; this.handleRecipientSnapshot(snap, callback),
      () &#x3D;&gt; {}
    );
    return unsubscribe;
  }

  /** Processes the snapshot data and invokes the callback with the appropriate status info. */
  private handleRecipientSnapshot(
    docSnap: any,
    callback: (data: {
      isOnline: boolean;
      avatarUrl: string;
      name: string;
      email: string;
    }) &#x3D;&gt; void
  ): void {
    if (!docSnap.exists()) {
      callback({
        isOnline: false,
        avatarUrl: &#x27;assets/img/avatar.png&#x27;,
        name: &#x27;Unbekannt&#x27;,
        email: &#x27;&#x27;,
      });
      return;
    }
    const userData &#x3D; docSnap.data() as any;
    const avatarUrl &#x3D; userData.avatarUrl || &#x27;assets/img/avatar.png&#x27;;
    const name &#x3D; userData.name || &#x27;Unbekannt&#x27;;
    const isOnline &#x3D; !!userData.isOnline;
    const email &#x3D; userData.email || &#x27;&#x27;;

    callback({ isOnline, avatarUrl, name, email });
  }

  public onAllUsersChanged(callback: (allUsers: any[]) &#x3D;&gt; void): () &#x3D;&gt; void {
    const collRef &#x3D; collection(this.firestore, &#x27;users&#x27;);
    const unsubscribe &#x3D; onSnapshot(collRef, (snapshot) &#x3D;&gt; {
      const users &#x3D; snapshot.docs.map((docSnap) &#x3D;&gt; {
        const userData &#x3D; docSnap.data() as any;
        return {
          ...userData,
          isOnline: !!userData.isOnline,
          avatarUrl: userData.avatarUrl || &#x27;assets/img/avatar.png&#x27;,
          name: userData.name || &#x27;Unbekannt&#x27;,
          email: userData.email || &#x27;&#x27;,
          id: docSnap.id,
        };
      });
      callback(users);
    });
    return unsubscribe;
  }

  public async setUserOnlineStatus(
    userId: string,
    isOnline: boolean
  ): Promise&lt;void&gt; {
    const userDocRef &#x3D; doc(this.firestore, &#x27;users&#x27;, userId);
    await updateDoc(userDocRef, { isOnline });
  }

  /**
   * Creates a message in Firestore with &quot;channel&quot; type.
   * @param data - The channel message data
   * @returns A promise resolving to the Firestore doc ID
   */
  public async sendChannelMessage(data: ChannelMessageData): Promise&lt;string&gt; {
    if (!data.channelId) {
      throw new Error(&#x27;Missing &quot;channelId&quot; in sendChannelMessage.&#x27;);
    }
    const finalTimestamp &#x3D; data.timestamp || serverTimestamp();
    const messageRef &#x3D; collection(this.firestore, &#x27;messages&#x27;);
    const messageObj &#x3D; {
      ...data,
      timestamp: finalTimestamp,
      type: &#x27;channel&#x27;,
    };
    const docRef &#x3D; await addDoc(messageRef, messageObj);
    return docRef.id;
  }

  /**
   * Saves a broadcast message in Firestore with &quot;broadcast&quot; type.
   * @param data - The broadcast message data
   * @returns A promise resolving to the Firestore doc ID
   */
  public async sendBroadcastMessage(
    data: BroadcastMessageData
  ): Promise&lt;string&gt; {
    if (!data.broadcastChannels?.length) {
      throw new Error(&#x27;Missing &quot;broadcastChannels&quot; in sendBroadcastMessage.&#x27;);
    }
    const docRef &#x3D; await addDoc(collection(this.firestore, &#x27;messages&#x27;), {
      ...data,
      timestamp: serverTimestamp(),
      type: &#x27;broadcast&#x27;,
    });
    return docRef.id;
  }

  /**
   * Retrieves all broadcast messages for the specified channel ID.
   * Messages are returned in ascending order by timestamp.
   * @param channelId - The channel ID used to filter broadcast messages
   * @returns An Observable emitting an array of broadcast messages
   */
  public getBroadcastMessages(channelId: string): Observable&lt;any[]&gt; {
    const messagesRef &#x3D; collection(this.firestore, &#x27;messages&#x27;);
    const q &#x3D; query(
      messagesRef,
      where(&#x27;type&#x27;, &#x27;&#x3D;&#x3D;&#x27;, &#x27;broadcast&#x27;),
      where(&#x27;broadcastChannels&#x27;, &#x27;array-contains&#x27;, channelId),
      orderBy(&#x27;timestamp&#x27;, &#x27;asc&#x27;)
    );
    return collectionData(q, { idField: &#x27;id&#x27; }) as Observable&lt;any[]&gt;;
  }



/**
 * Finds the main channelId for a thread-channel message by checking its
 * own channelId field or looking up the parent message if channelId is null.
 * @param msg - The message object (requires threadChannelId or parentId).
 * @returns A promise resolving to the channel ID or null if not found.
 */
public async findChannelIdIfMissing(msg: any): Promise&lt;string | null&gt; {
  if (msg[&#x27;channelId&#x27;]) {
    return msg[&#x27;channelId&#x27;];
  }
  const parentId &#x3D; msg[&#x27;threadChannelId&#x27;] ?? msg[&#x27;parentId&#x27;];
  if (!parentId) {
    return null;
  }
  const parentRef &#x3D; doc(this.firestore, &#x27;messages&#x27;, parentId);
  const parentSnap &#x3D; await getDoc(parentRef);
  if (!parentSnap.exists()) {
    return null;
  }
  return parentSnap.data()?.[&#x27;channelId&#x27;] || null;
}


}
</code></pre>
    </div>

</div>













                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

          <label class="dark-mode-switch">
               <input type="checkbox">
               <span class="slider">
                    <svg class="slider-icon" viewBox="0 0 24 24" fill="none" height="20" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" width="20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
                    </svg>
               </span>
          </label>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'injectable';
            var COMPODOC_CURRENT_PAGE_URL = 'MessageService.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script>
               $darkModeToggleSwitchers = document.querySelectorAll('.dark-mode-switch input');
               checkToggle(darkModeState);
               if ($darkModeToggleSwitchers.length > 0) {
                    for (var i = 0; i < $darkModeToggleSwitchers.length; i++) {
                         $darkModeToggleSwitchers[i].addEventListener('change', function (event) {
                              darkModeState = !darkModeState;
                              toggleDarkMode(darkModeState);
                         });
                    }
               }
          </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>

       <script src="../js/menu-wc.js" defer></script>
       <script nomodule src="../js/menu-wc_es5.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
